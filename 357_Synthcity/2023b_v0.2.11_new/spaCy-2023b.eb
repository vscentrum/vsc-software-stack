easyblock = 'PythonBundle'

name = 'spaCy'
version = '3.7.5'

homepage = 'https://spacy.io/'
description = "Industrial-strength Natural Language Processing (NLP) in Python."

toolchain = {'name': 'foss', 'version': '2023b'}

builddependencies = [
    ('poetry', '1.6.1'),
    ('hatchling', '1.18.0'),
    # ('Cython', '0.29.37'),
]

dependencies = [
    ('Python', '3.11.5'),
    ('Python-bundle-PyPI', '2023.10'),
    ('SciPy-bundle', '2023.11'),
    ('tqdm', '4.66.2'),
    ('pydantic', '2.6.4'),
]

use_pip = True

exts_list = [
    # srsly and thinc needs Cython<3 as build dependency, but in Python-bundle-PyPI there is 
    # Cython>3 - this is a mistake in a Python-bundle-PyPI and should not be in future versions
    # so this dependency could be removed with more recent version of Python-bundle-PyPI
    ('Cython', '0.29.37', {
        'checksums': ['f813d4a6dd94adee5d4ff266191d1d95bf6d4164a4facc535422c021b2504cfb'],
    }),
    ('spacy-legacy', '3.0.12', {
        'checksums': ['b37d6e0c9b6e1d7ca1cf5bc7152ab64a4c4671f59c85adaf7a3fcb870357a774'],
    }),
    ('spacy-loggers', '1.0.5', {
        'checksums': ['d60b0bdbf915a60e516cc2e653baeff946f0cfc461b452d11a4d5458c6fe5f24'],
    }),
    ('cymem', '2.0.8', {
        'checksums': ['8fb09d222e21dcf1c7e907dc85cf74501d4cea6c4ed4ac6c9e016f98fb59cbbf'],
    }),
    ('murmurhash', '1.0.10', {
        'checksums': ['5282aab1317804c6ebd6dd7f69f15ba9075aee671c44a34be2bde0f1b11ef88a'],
    }),
    ('preshed', '3.0.9', {
        'checksums': ['721863c5244ffcd2651ad0928951a2c7c77b102f4e11a251ad85d37ee7621660'],
    }),
    ('blis', '0.7.11', {
        'checksums': ['cec6d48f75f7ac328ae1b6fbb372dde8c8a57c89559172277f66e01ff08d4d42'],
    }),
    ('wasabi', '1.1.2', {
        'checksums': ['1aaef3aceaa32edb9c91330d29d3936c0c39fdb965743549c173cb54b16c30b5'],
    }),
    ('catalogue', '2.0.10', {
        'checksums': ['4f56daa940913d3f09d589c191c74e5a6d51762b3a9e37dd53b7437afd6cda15'],
    }),
    ('confection', '0.1.5', {
        'checksums': ['8e72dd3ca6bd4f48913cd220f10b8275978e740411654b6e8ca6d7008c590f0e'],
    }),
    ('srsly', '2.4.8', {
        'checksums': ['b24d95a65009c2447e0b49cda043ac53fecf4f09e358d87a57446458f91b8a91'],
    }),
    ('thinc', '8.2.5', {
        'checksums': ['c2963791c934cc7fbd8f9b942d571cac79892ad11630bfca690a868c32752b75'],
    }),
    ('ml_datasets', '0.2.0', {
        'checksums': ['3f9c8901f8d6be3dab5b23ec3a6c01e619a60d0184696b1030cde2e3086943f1'],
    }),
    ('typer', '0.9.1', {
        'checksums': ['1cf0d77ad59eed73bf0e414b0258f523732afc7bd896122fd724910ddf308abc'],
    }),
    ('smart-open', '6.4.0', {
        'source_tmpl': 'smart_open-%(version)s.tar.gz',
        'checksums': ['be3c92c246fbe80ebce8fbacb180494a481a77fcdcb7c1aadb2ea5b9c2bee8b9'],
    }),
    ('langcodes', '3.3.0', {
        'checksums': ['794d07d5a28781231ac335a1561b8442f8648ca07cd518310aeb45d6f0807ef6'],
    }),
    ('weasel', '0.3.4', {
        'checksums': ['eb16f92dc9f1a3ffa89c165e3a9acd28018ebb656e0da4da02c0d7d8ae3f6178'],
    }),
    ('cloudpathlib', '0.16.0', {
        'checksums': ['cdfcd35d46d529587d744154a0bdf962aca953b725c8784cd2ec478354ea63a3'],
    }),
    (name, version, {
        'sources': ['%(namelower)s-%(version)s.tar.gz'],
        'checksums': ['a648c6cbf2acc7a55a69ee9e7fa4f22bdf69aa828a587a1bc5cfff08cf3c2dd3'],
    }),
]

sanity_pip_check = True

moduleclass = 'data'

# E1:
    # probably problem with cython version -> it needs cython<3 for setup but for foss/2023b is cython>3 -> do EC for cython<3
    # -> https://github.com/cython/cython/issues/5757
    # <- log1.txt
    # <- fails on "pip install thinc-8.2.3"
    # thinc/backends/numpy_ops.pyx:472:32: Cannot assign type 'daxpy_ptr' to 'ptr'. Exception values are incompatible. Suggest adding 'noexcept' to type 'void (int, double, const double *, int, double *, int) except * nogil'.
    #       Cythonizing sources
    #       Compiling thinc/backends/cblas.pyx because it changed.
    #       Compiling thinc/backends/linalg.pyx because it changed.
    #       Compiling thinc/backends/numpy_ops.pyx because it changed.
    #       Compiling thinc/extra/search.pyx because it changed.
    #       Compiling thinc/layers/sparselinear.pyx because it changed.
    #       Compiling thinc/layers/premap_ids.pyx because it changed.
    #       [1/6] Cythonizing thinc/backends/cblas.pyx
    #       [2/6] Cythonizing thinc/backends/linalg.pyx
    #       [3/6] Cythonizing thinc/backends/numpy_ops.pyx
    #       Traceback (most recent call last):
    #         File "/apps/gent/RHEL8/cascadelake-ib/software/Python/3.11.5-GCCcore-13.2.0/lib/python3.11/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py", line 353, in <module>
    #           main()
    #         File "/apps/gent/RHEL8/cascadelake-ib/software/Python/3.11.5-GCCcore-13.2.0/lib/python3.11/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py", line 335, in main
    #           json_out['return_val'] = hook(**hook_input['kwargs'])
    #                                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    #         File "/apps/gent/RHEL8/cascadelake-ib/software/Python/3.11.5-GCCcore-13.2.0/lib/python3.11/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py", line 149, in prepare_metadata_for_build_wheel
    #           return hook(metadata_directory, config_settings)
    #                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    #         File "/apps/gent/RHEL8/cascadelake-ib/software/Python/3.11.5-GCCcore-13.2.0/lib/python3.11/site-packages/setuptools/build_meta.py", line 396, in prepare_metadata_for_build_wheel
    #           self.run_setup()
    #         File "/apps/gent/RHEL8/cascadelake-ib/software/Python/3.11.5-GCCcore-13.2.0/lib/python3.11/site-packages/setuptools/build_meta.py", line 341, in run_setup
    #           exec(code, locals())
    #         File "<string>", line 101, in <module>
    #         File "<string>", line 86, in setup_package
    #         File "/apps/gent/RHEL8/cascadelake-ib/software/Python-bundle-PyPI/2023.10-GCCcore-13.2.0/lib/python3.11/site-packages/Cython/Build/Dependencies.py", line 1154, in cythonize
    #           cythonize_one(*args)
    #         File "/apps/gent/RHEL8/cascadelake-ib/software/Python-bundle-PyPI/2023.10-GCCcore-13.2.0/lib/python3.11/site-packages/Cython/Build/Dependencies.py", line 1321, in cythonize_one
    #           raise CompileError(None, pyx_file)
    #       Cython.Compiler.Errors.CompileError: thinc/backends/numpy_ops.pyx
    #       [end of output]