easyblock = 'PythonBundle'

name = 'EasyMocap'
version = '0.2'

homepage = 'https://chingswy.github.io/easymocap-public-doc/'
description = """EasyMoCap is an open-source toolbox designed for markerless
 human motion capture from RGB videos. This project offers a wide range of motion
 capture methods across various settings."""

toolchain = {'name': 'foss', 'version': '2023a'}

builddependencies = [
    # for mediapipe
    ('Bazel', '6.3.1'),
    ('Python-bundle-PyPI', '2023.06'),
]

dependencies = [
    ('Python', '3.11.3'),
    ('PyTorch', '2.1.2'),
    ('torchvision', '0.16.0'),
    ('tqdm', '4.66.1'),
    ('OpenCV', '4.8.1', '-contrib'),
    # for pyrender
    ('freetype-py', '2.4.0'),
    ('imageio', '2.33.1'),
    ('networkx', '3.1'),
    ('PyOpenGL', '3.1.7'),
    ('trimesh', '4.1.7'),
    # for ipdb
    ('IPython', '8.14.0'),
]

use_pip = True
sanity_pip_check = True

exts_list = [
    # TODO maybe also include these deps?: https://github.com/zju3dv/EasyMocap/blob/v0.2/requirements_neuralbody.txt
    ('chumpy', '0.70', {
        'checksums': ['a0275c2018784ca1302875567dc81761f5fd469fab9f3ac0f3e7c39e9180350a'],
    }),
    ('func_timeout', '4.3.5', {
        'checksums': ['74cd3c428ec94f4edfba81f9b2f14904846d5ffccc27c92433b8b5939b5575dd'],
    }),
    ('ipdb', '0.13.13', {
        'source_tmpl': SOURCE_PY3_WHL,
        'checksums': ['45529994741c4ab6d2388bfa5d7b725c2cf7fe9deffabdb8a6113aa5ed449ed4'],
    }),
    ('termcolor', '2.4.0', {
        'source_tmpl': SOURCE_PY3_WHL,
        'checksums': ['9297c0df9c99445c2412e832e882a7884038a25617c60cea2ad69488d4040d63'],
    }),
    ('yacs', '0.1.8', {
        'source_tmpl': SOURCE_PY3_WHL,
        'checksums': ['99f893e30497a4b66842821bac316386f7bd5c4f47ad35c9073ef089aa33af32'],
    }),
    ('pyglet', '2.0.12', {
        'source_tmpl': SOURCE_PY3_WHL,
        'checksums': ['b713db0f1d939040b58dbe4583f5999540623ffae9de8c7171be26ece94eaecf'],
    }),
    ('pyrender', '0.1.45', {
        # PyOpenGL requirement is too strict
        'preinstallopts': "sed -i 's/PyOpenGL==3.1.0/PyOpenGL>=3.1.0/g' setup.py && ",
        'checksums': ['284b2432bf6832f05c5216c4b979ceb514ea78163bf53b8ce2bdf0069cb3b92e'],
    }),
    ('mediapipe', '0.10.10', {
        'source_urls': ['https://github.com/google/mediapipe/archive'],
        'preinstallopts': 'echo here && whereis bazel && ',
        'sources': ['v%(version)s.tar.gz'],
        'checksums': ['030d069da7108f67496c9e2d151c4ccab47552fabe8f0d6ef3b03de77a5a13b7'],
    }),
    # TODO
    # Traceback (most recent call last):
    #     File "<string>", line 2, in <module>
    #     File "<pip-setuptools-caller>", line 34, in <module>
    #     File "/tmp/vsc45304/easybuild/build/EasyMocap/0.2/foss-2023a/mediapipe/mediapipe-0.10.10/setup.py", line 520, in <module>
    #       setuptools.setup(
    #     File "/scratch/gent/vo/001/gvo00117/easybuild/RHEL8/cascadelake-ampere-ib/software/Python/3.11.3-GCCcore-12.3.0/lib/python3.11/site-packages/setuptools/__init__.py", line 107, in setup
    #       return distutils.core.setup(**attrs)
    #              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    #     File "/scratch/gent/vo/001/gvo00117/easybuild/RHEL8/cascadelake-ampere-ib/software/Python/3.11.3-GCCcore-12.3.0/lib/python3.11/site-packages/setuptools/_distutils/core.py", line 185, in setup
    #       return run_commands(dist)
    #              ^^^^^^^^^^^^^^^^^^
    #     File "/scratch/gent/vo/001/gvo00117/easybuild/RHEL8/cascadelake-ampere-ib/software/Python/3.11.3-GCCcore-12.3.0/lib/python3.11/site-packages/setuptools/_distutils/core.py", line 201, in run_commands
    #       dist.run_commands()
    #     File "/scratch/gent/vo/001/gvo00117/easybuild/RHEL8/cascadelake-ampere-ib/software/Python/3.11.3-GCCcore-12.3.0/lib/python3.11/site-packages/setuptools/_distutils/dist.py", line 969, in run_commands
    #       self.run_command(cmd)
    #     File "/scratch/gent/vo/001/gvo00117/easybuild/RHEL8/cascadelake-ampere-ib/software/Python/3.11.3-GCCcore-12.3.0/lib/python3.11/site-packages/setuptools/dist.py", line 1244, in run_command
    #       super().run_command(command)
    #     File "/scratch/gent/vo/001/gvo00117/easybuild/RHEL8/cascadelake-ampere-ib/software/Python/3.11.3-GCCcore-12.3.0/lib/python3.11/site-packages/setuptools/_distutils/dist.py", line 987, in run_command
    #       cmd_obj.ensure_finalized()
    #     File "/scratch/gent/vo/001/gvo00117/easybuild/RHEL8/cascadelake-ampere-ib/software/Python/3.11.3-GCCcore-12.3.0/lib/python3.11/site-packages/setuptools/_distutils/cmd.py", line 111, in ensure_finalized
    #       self.finalize_options()
    #     File "/scratch/gent/vo/001/gvo00117/easybuild/RHEL8/cascadelake-ampere-ib/software/Python/3.11.3-GCCcore-12.3.0/lib/python3.11/site-packages/setuptools/command/egg_info.py", line 219, in finalize_options
    #       parsed_version = packaging.version.Version(self.egg_version)
    #                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    #     File "/scratch/gent/vo/001/gvo00117/easybuild/RHEL8/cascadelake-ampere-ib/software/Python/3.11.3-GCCcore-12.3.0/lib/python3.11/site-packages/setuptools/_vendor/packaging/version.py", line 197, in __init__
    #       raise InvalidVersion(f"Invalid version: '{version}'")
    #   setuptools.extern.packaging.version.InvalidVersion: Invalid version: 'dev'
    (name, version, {
        'patches': ['deps.patch'],  # TODO just for pip check
        'source_urls': ['https://github.com/zju3dv/EasyMocap/archive'],
        'sources': ['v%(version)s.tar.gz'],
        'checksums': ['d4c42b82ea8a53662354ff70b775e505c654ca4fd51524029214acbc16aa9773'],
    }),
]

# sanity_check_commands = [f"python -c 'import {dep}'" for dep in local_deps]

moduleclass = 'vis'
