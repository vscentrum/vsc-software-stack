easyblock = 'MakeCp'

name = 'FDMNES'

version = '2024-02-15'

homepage = 'https://fdmnes.neel.cnrs.fr'
description = """X-ray spectroscopies are techniques which probe the electronic and structural
properties of the materials. Most often performed at synchrotron, they are extensively used
to analyse all classes of materials. The advances on the experimental side need the complementary
progress on the theoretical side to extract confidentely all the information the data can furnish.

In this context, the purpose of our FDMNES project is to supply to the community a user friendly
ab initio code to simulate X-ray absorption and emission spectroscopies as well as resonant x-ray
scattering and x-ray Raman spectroscopies, among other techniques.

FDMNES, for Finite Difference Method Near Edge Structure, uses the density functional theory (DFT).
It is thus specially devoted to the simulation of the K edges of all the chemical elements and of the L23 edges of the heavy ones.
For the other edges, it includes advances by the use of the time dependent DFT (TD-DFT)."""

toolchain = {'name': 'gomkl', 'version': '2023a'}

sources = [{
    'source_urls': ['https://cloud.neel.cnrs.fr/index.php/s/NqfkSySpqSB4CyK'],
    'download_filename': 'download',
    'filename': '%(namelower)s_fortran_prog_%(version)s.zip',
}]

checksums = ['5ffce6825d21faf849f22f66aeae22cce4a922057192f7c98e9eaedaf2dbf2c7']

dependencies = [
    ('MUMPS', '5.6.1', '-metis'),
    ('OpenMPI', '4.1.5'),
]

parallel = 1  # TODO helped with the Cannot open module file declarations.mod
# TODO but:
# main.f90:1248:19:
#
#  1246 |     call MPI_Bcast(Check_mpi,1,MPI_LOGICAL,0,MPI_COMM_WORLD,mpierr)
#       |                   2
#  1247 |     if( Check_mpi ) then
#  1248 |     call MPI_Bcast(icheck,30,MPI_INTEGER,0,MPI_COMM_WORLD,mpierr)
#       |                   1
# Error: Type mismatch between actual argument at (1) and actual argument at (2) (INTEGER(4)/LOGICAL(4)).

buildopts = 'FC="$FC" FFLAGS="$FFLAGS -fallow-argument-mismatch -I$EBROOTOPENMPI/include -I$EBROOTMUMPS/include"'

files_to_copy = [
    (['fdmness'], 'bin'),
]

sanity_check_paths = {
    'files': ['bin/fdmnes'],
    'dirs': []
}

sanity_check_commands = ['fdmnes --help']

moduleclass = 'chem'
