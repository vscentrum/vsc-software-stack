easyblock = 'MakeCp'

name = 'NextDenovo'
version = '2.5.2-20240510'
local_commit = '0e5fa5d'

homepage = 'https://github.com/Nextomics/NextDenovo'
description = 'NextDenovo is a string graph-based de novo assembler for long reads.'

toolchain = {'name': 'GCC', 'version': '12.3.0'}

source_urls = ['https://github.com/Nextomics/NextDenovo/archive/']
sources = [{'download_filename': '0e5fa5d.tar.gz', 'filename': SOURCE_TAR_GZ}]
checksums = ['bbe43124e7d63cbe33179c2abf2de60797bb7361a7f7a2b5fc33bf62a4479726']

builddependencies = [('binutils', '2.40')]
dependencies = [
    ('Python', '3.11.3'),
    ('Python-bundle-PyPI', '2023.06'),
    ('HTSlib', '1.9', 'fPIC-test'),
    # ('cURL', '8.0.1'),
    # ('cURL', '7.86.0'),
    # ('cURL', '7.66.0'),
    # ('cURL', '7.60.0'),
]

exts_defaultclass = 'PythonPackage'
exts_default_options = {
    'source_urls': [PYPI_SOURCE],
    'download_dep_fail': True,
    'use_pip': True,
    'sanity_pip_check': True,
    'preinstallopts': '',
    'installopts': '',
}

exts_list = [
    ('Paralleltask', '0.2.3', {
        'modulename': 'paralleltask',
        'checksums': ['8015a8311d5021bc44edbfbf45ff2557a529999e235d25190bac62993fdf7b66'],
    }),
]

# buildopts = 'HTSDIR=$EBROOTHTSLIB/lib'
parallel = 1
# prebuildopts = "sed -i 's/seq_count bwa samtools minimap2/seq_count samtools minimap2/' Makefile && "
prebuildopts = "rm -rf lib/htslib && mkdir lib/htslib && "
prebuildopts += "cd %(start_dir)s/lib/htslib && ln -s $EBROOTHTSLIB/lib/libhts.a && ln -s $EBROOTHTSLIB/lib/libhts.so && cd %(start_dir)s && "
prebuildopts += (
    "sed -i"
    " -e '10,13d'"
    " -e 's|$(HTSDIR)/libhts.a||'"
    " lib/Makefile && "
)
prebuildopts += (
    "sed -i"
    " -e 's|$(HTSDIR)/libhts.a||'"
    " -e '10,13d'"
    " util/Makefile && "
)

files_to_copy = ['bin', 'lib', 'test_data', 'LICENSE', 'nextDenovo']

sanity_check_paths = {
    'files': ['nextDenovo', 'bin/minimap2-nd', 'bin/paralleltask', 'bin/nextgraph'],
    'dirs': ['bin', 'test_data', 'lib/python%(pyshortver)s/site-packages'],
}

sanity_check_commands = ['nextDenovo --help']

modextrapaths = {
    'PYTHONPATH': 'lib/python%(pyshortver)s/site-packages',
    'PATH': '',
}

moduleclass = 'bio'

# ERROR1: 
    # add HTSlib from EB and replace their own HTSlib:
        # -> added buildopts = 'HTSDIR=$EBROOTHTSLIB/lib' -> error bin/ld: failed to set dynamic section sizes: bad value of htslib.o? ->
        # -> create HTSlib with toolchainopts = {'pic': True} -> log4.txt 
            # lot of "undefined reference to" errors -> linking error
            # /apps/gent/RHEL8/cascadelake-ib/software/binutils/2.40-GCCcore-12.3.0/bin/ld: /scratch/gent/vo/001/gvo00117/easy
            # build/RHEL8/cascadelake-ampere-ib/software/HTSlib/1.18-GCC-12.3.0fPIC-test/lib/libhts.a(hts.o): in function `hts
            # _detect_format2':
            # hts.c:(.text+0x287d): undefined reference to `lzma_easy_decoder_memusage'
            # /apps/gent/RHEL8/cascadelake-ib/software/binutils/2.40-GCCcore-12.3.0/bin/ld: hts.c:(.text+0x288a): undefined re
            # ference to `lzma_stream_decoder'
            # /apps/gent/RHEL8/cascadelake-ib/software/binutils/2.40-GCCcore-12.3.0/bin/ld: hts.c:(.text+0x28b9): undefined re
            # ference to `lzma_code'
            # /apps/gent/RHEL8/cascadelake-ib/software/binutils/2.40-GCCcore-12.3.0/bin/ld: hts.c:(.text+0x28cf): undefined re
            # ference to `lzma_end'
            # /apps/gent/RHEL8/cascadelake-ib/software/binutils/2.40-GCCcore-12.3.0/bin/ld: hts.c:(.text+0x3096): undefined reference to `lzma_end'
            # /apps/gent/RHEL8/cascadelake-ib/software/binutils/2.40-GCCcore-12.3.0/bin/ld: /scratch/gent/vo/001/gvo00117/easybuild/RHEL8/cascadelake-ampere-ib/software/HTSlib/1.18-GCC-12.3.0fPIC-test/lib/libhts.a(cram_io.o): in function `cram_compress_by_method.constprop.0':
            # cram_io.c:(.text+0x190c): undefined reference to `BZ2_bzBuffToBuffCompress'
            # /apps/gent/RHEL8/cascadelake-ib/software/binutils/2.40-GCCcore-12.3.0/bin/ld: cram_io.c:(.text+0x1934): undefined reference to `lzma_stream_buffer_bound'
            # /apps/gent/RHEL8/cascadelake-ib/software/binutils/2.40-GCCcore-12.3.0/bin/ld: cram_io.c:(.text+0x1965): undefined reference to `lzma_easy_buffer_encode'
            # /apps/gent/RHEL8/cascadelake-ib/software/binutils/2.40-GCCcore-12.3.0/bin/ld: /scratch/gent/vo/001/gvo00117/easybuild/RHEL8/cascadelake-ampere-ib/software/HTSlib/1.18-GCC-12.3.0fPIC-test/lib/libhts.a(cram_io.o): in function `cram_uncompress_block':
            # cram_io.c:(.text+0x6ca7): undefined reference to `BZ2_bzBuffToBuffDecompress'
            # /apps/gent/RHEL8/cascadelake-ib/software/binutils/2.40-GCCcore-12.3.0/bin/ld: cram_io.c:(.text+0x6d23): undefined reference to `lzma_easy_decoder_memusage'
            # /apps/gent/RHEL8/cascadelake-ib/software/binutils/2.40-GCCcore-12.3.0/bin/ld: cram_io.c:(.text+0x6d30): undefined reference to `lzma_stream_decoder'
            # /apps/gent/RHEL8/cascadelake-ib/software/binutils/2.40-GCCcore-12.3.0/bin/ld: cram_io.c:(.text+0x6da3): undefined reference to `lzma_code'
            # /apps/gent/RHEL8/cascadelake-ib/software/binutils/2.40-GCCcore-12.3.0/bin/ld: cram_io.c:(.text+0x6dca): undefined reference to `lzma_code'
            # /apps/gent/RHEL8/cascadelake-ib/software/binutils/2.40-GCCcore-12.3.0/bin/ld: cram_io.c:(.text+0x6e05): undefined reference to `lzma_end'
            # /apps/gent/RHEL8/cascadelake-ib/software/binutils/2.40-GCCcore-12.3.0/bin/ld: cram_io.c:(.text+0x6fd0): undefined reference to `lzma_end'
            # /apps/gent/RHEL8/cascadelake-ib/software/binutils/2.40-GCCcore-12.3.0/bin/ld: cram_io.c:(.text+0x7030): undefined reference to `lzma_end'
            # /apps/gent/RHEL8/cascadelake-ib/software/binutils/2.40-GCCcore-12.3.0/bin/ld: /scratch/gent/vo/001/gvo00117/easybuild/RHEL8/cascadelake-ampere-ib/software/HTSlib/1.18-GCC-12.3.0fPIC-test/lib/libhts.a(arith_dynamic.o): in function `arith_compress_to':
            # arith_dynamic.c:(.text+0x2216): undefined reference to `BZ2_bzBuffToBuffCompress'
            # /apps/gent/RHEL8/cascadelake-ib/software/binutils/2.40-GCCcore-12.3.0/bin/ld: /scratch/gent/vo/001/gvo00117/easybuild/RHEL8/cascadelake-ampere-ib/software/HTSlib/1.18-GCC-12.3.0fPIC-test/lib/libhts.a(arith_dynamic.o): in function `arith_uncompress_to':
            # arith_dynamic.c:(.text+0x4c65): undefined reference to `BZ2_bzBuffToBuffDecompress'
            # collect2: error: ld returned 1 exit status
            # make[1]: *** [Makefile:30: bam_sort] Error 1