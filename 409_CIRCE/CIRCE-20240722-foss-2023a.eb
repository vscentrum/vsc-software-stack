easyblock = 'PythonBundle'

name = 'CIRCE'
version = '0.2.2'

homepage = 'https://github.com/cantinilab/Circe'
description = """This repo contains a python package for inferring co-accessibility networks
 from single-cell ATAC-seq data, using skggm for the graphical lasso and scanpy for data processing."""

toolchain = {'name': 'foss', 'version': '2023a'}

builddependencies = [
    ('poetry', '1.5.1'),
]

dependencies = [
    ('Python', '3.11.3'),
    ('SciPy-bundle', '2023.07'),
    ('scikit-learn', '1.3.1'),
    ('scanpy', '1.9.8'),
]

use_pip = True
sanity_pip_check = True

exts_list = [
    ('joblib', '1.4.2', {
        'source_tmpl': SOURCE_PY3_WHL,
        'checksums': ['06d478d5674cbc267e7496a410ee875abd68e4340feff4490bcb7afb88060ae6'],
    }),
    ('rich', '13.8.0', {
        'source_tmpl': SOURCE_PY3_WHL,
        'checksums': ['2e85306a063b9492dffc86278197a60cbece75bcb766022f3436f567cae11bdc'],
    }),
    ('circe_py', version, {
        'modulename': 'circe',
        'patches': ['CIRCE-20240722_requirements.patch'],
        'checksums': [
            {'circe_py-0.2.2.tar.gz': '0b828b8819bf1f0a6884016deb73e8551ac1d505c9091fbff2643dd48ebcc20e'},
            {'CIRCE-20240722_requirements.patch': '8d957f12732118cc36d2700ba2f18ebb260d288c1db372951d435e5aabe3a606'},
        ],
        # build the C components and link `flexiblas` instead of `lapack`
        'preinstallopts': "sed -i 's/lapack/flexiblas/g' build.py && echo here1 && poetry build && echo here2 && ",
    }),
]

moduleclass = 'bio'

# TODO
# Traceback (most recent call last):
#   File "/kyukon/home/gent/453/vsc45304/vsc-software-stack/409_CIRCE/run.py", line 20, in <module>
#     ci.compute_atac_network(
#   File "/scratch/gent/vo/001/gvo00117/easybuild/RHEL8/cascadelake-ampere-ib/software/CIRCE/0.2.2-foss-2023a/lib/python3.11/site-packages/circe/circe.py", line 264, in compute_atac_network
#     anndata.varp[key] = sliding_graphical_lasso(
#                         ^^^^^^^^^^^^^^^^^^^^^^^^
#   File "/scratch/gent/vo/001/gvo00117/easybuild/RHEL8/cascadelake-ampere-ib/software/CIRCE/0.2.2-foss-2023a/lib/python3.11/site-packages/circe/circe.py", line 929, in sliding_graphical_lasso
#     alpha = average_alpha(
#             ^^^^^^^^^^^^^^
#   File "/scratch/gent/vo/001/gvo00117/easybuild/RHEL8/cascadelake-ampere-ib/software/CIRCE/0.2.2-foss-2023a/lib/python3.11/site-packages/circe/circe.py", line 693, in average_alpha
#     alpha = local_alpha(
#             ^^^^^^^^^^^^
#   File "/scratch/gent/vo/001/gvo00117/easybuild/RHEL8/cascadelake-ampere-ib/software/CIRCE/0.2.2-foss-2023a/lib/python3.11/site-packages/circe/circe.py", line 502, in local_alpha
#     results = graph_lasso_model.fit(cov).precision_
#               ^^^^^^^^^^^^^^^^^^^^^^^^^^
#   File "/scratch/gent/vo/001/gvo00117/easybuild/RHEL8/cascadelake-ampere-ib/software/CIRCE/0.2.2-foss-2023a/lib/python3.11/site-packages/circe/quic_graph_lasso.py", line 352, in fit
#     ) = quic(
#         ^^^^^
#   File "/scratch/gent/vo/001/gvo00117/easybuild/RHEL8/cascadelake-ampere-ib/software/CIRCE/0.2.2-foss-2023a/lib/python3.11/site-packages/circe/quic_graph_lasso.py", line 129, in quic
#     pyquic.quic(
#     ^^^^^^^^^^^
# AttributeError: module 'circe.pyquic' has no attribute 'quic'

# TODO still no `quic.py` in `lib/python3.11/site-packages/circe/pyquic/`
# Creating virtualenv circe-py-yjxQWa7c-py3.11 in /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/xdg-cache-home/pypoetry/virtualenvs
#
# ESC[1GESC[2KPreparing build environment with build-system requirements poetry>=0.12, setuptools, numpy<2.0Building circe-py (0.2.2)
# A setup.py file already exists. Using it.
# /tmp/vsc45304/eb-l3l1f3o9/tmplde8q1zg/.venv/lib/python3.11/site-packages/setuptools/_distutils/extension.py:139: UserWarning: Unknown Extension options: 'packages'
#   warnings.warn(msg)
# running build
# running build_py
# creating /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe
# copying circe/ccan_module.py -> /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe
# copying circe/quic_graph_lasso.py -> /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe
# copying circe/metacells.py -> /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe
# copying circe/rank_correlation.py -> /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe
# copying circe/inverse_covariance.py -> /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe
# copying circe/metrics.py -> /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe
# copying circe/circe.py -> /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe
# copying circe/draw.py -> /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe
# copying circe/__init__.py -> /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe
# copying circe/ccan_module.py -> /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe
# copying circe/quic_graph_lasso.py -> /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe
# copying circe/metacells.py -> /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe
# copying circe/rank_correlation.py -> /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe
# copying circe/inverse_covariance.py -> /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe
# copying circe/metrics.py -> /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe
# copying circe/circe.py -> /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe
# copying circe/draw.py -> /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe
# copying circe/__init__.py -> /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe
# creating /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe/pyquic
# copying circe/pyquic/pyquic.cpp -> /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe/pyquic
# copying circe/pyquic/QUIC.h -> /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe/pyquic
# copying circe/pyquic/QUIC.C -> /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe/pyquic
# copying circe/pyquic/pyquic.pyx -> /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe/pyquic
# running build_ext
# skipping 'circe/pyquic/pyquic.cpp' Cython extension (up-to-date)
# building 'circe.pyquic' extension
# creating /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/temp.linux-x86_64-cpython-311/circe/pyquic
# gcc -DNDEBUG -g -fwrapv -O3 -Wall -O2 -ftree-vectorize -march=native -fno-math-errno -fPIC -O2 -ftree-vectorize -march=native -fno-math-errno -fPIC -O2 -ftree-vectorize -march=native -fno-math-errno -I/apps/gent/RHEL8/cascadelake-ib/software/FFTW/3.3.10-GCC-12.3.0/include -I/apps/gent/RHEL8/cascadelake-ib/software/FlexiBLAS/3.3.1-GCC-12.3.0/include -I/apps/gent/RHEL8/cascadelake-ib/software/FlexiBLAS/3.3.1-GCC-12.3.0/include/flexiblas -fPIC -I/apps/gent/RHEL8/cascadelake-ib/software/SciPy-bundle/2023.07-gfbf-2023a/lib/python3.11/site-packages/numpy/core/include -I/usr/local/include -I/tmp/vsc45304/eb-l3l1f3o9/tmplde8q1zg/.venv/include -I/apps/gent/RHEL8/cascadelake-ib/software/Python/3.11.3-GCCcore-12.3.0/include/python3.11 -c circe/pyquic/QUIC.C -o /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/temp.linux-x86_64-cpython-311/circe/pyquic/QUIC.o -msse2 -O2 -fPIC -w
# g++ -O2 -ftree-vectorize -march=native -fno-math-errno -I/apps/gent/RHEL8/cascadelake-ib/software/FFTW/3.3.10-GCC-12.3.0/include -I/apps/gent/RHEL8/cascadelake-ib/software/FlexiBLAS/3.3.1-GCC-12.3.0/include -I/apps/gent/RHEL8/cascadelake-ib/software/FlexiBLAS/3.3.1-GCC-12.3.0/include/flexiblas -fPIC -I/apps/gent/RHEL8/cascadelake-ib/software/SciPy-bundle/2023.07-gfbf-2023a/lib/python3.11/site-packages/numpy/core/include -I/usr/local/include -I/tmp/vsc45304/eb-l3l1f3o9/tmplde8q1zg/.venv/include -I/apps/gent/RHEL8/cascadelake-ib/software/Python/3.11.3-GCCcore-12.3.0/include/python3.11 -c circe/pyquic/pyquic.cpp -o /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/temp.linux-x86_64-cpython-311/circe/pyquic/pyquic.o -msse2 -O2 -fPIC -w
# g++ -O2 -ftree-vectorize -march=native -fno-math-errno -I/apps/gent/RHEL8/cascadelake-ib/software/FFTW/3.3.10-GCC-12.3.0/include -I/apps/gent/RHEL8/cascadelake-ib/software/FlexiBLAS/3.3.1-GCC-12.3.0/include -I/apps/gent/RHEL8/cascadelake-ib/software/FlexiBLAS/3.3.1-GCC-12.3.0/include/flexiblas -shared -L/apps/gent/RHEL8/cascadelake-ib/software/FFTW/3.3.10-GCC-12.3.0/lib64 -L/apps/gent/RHEL8/cascadelake-ib/software/FFTW/3.3.10-GCC-12.3.0/lib -L/scratch/gent/vo/001/gvo00117/easybuild/RHEL8/cascadelake-ampere-ib/software/ScaLAPACK/2.2.0-gompi-2023a-fb/lib64 -L/scratch/gent/vo/001/gvo00117/easybuild/RHEL8/cascadelake-ampere-ib/software/ScaLAPACK/2.2.0-gompi-2023a-fb/lib -L/apps/gent/RHEL8/cascadelake-ib/software/FlexiBLAS/3.3.1-GCC-12.3.0/lib64 -L/apps/gent/RHEL8/cascadelake-ib/software/FlexiBLAS/3.3.1-GCC-12.3.0/lib -L/apps/gent/RHEL8/cascadelake-ib/software/GCCcore/12.3.0/lib64 -L/apps/gent/RHEL8/cascadelake-ib/software/GCCcore/12.3.0/lib -O2 -ftree-vectorize -march=native -fno-math-errno -I/apps/gent/RHEL8/cascadelake-ib/software/FFTW/3.3.10-GCC-12.3.0/include -I/apps/gent/RHEL8/cascadelake-ib/software/FlexiBLAS/3.3.1-GCC-12.3.0/include -I/apps/gent/RHEL8/cascadelake-ib/software/FlexiBLAS/3.3.1-GCC-12.3.0/include/flexiblas /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/temp.linux-x86_64-cpython-311/circe/pyquic/QUIC.o /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/temp.linux-x86_64-cpython-311/circe/pyquic/pyquic.o -L/apps/gent/RHEL8/cascadelake-ib/software/Python/3.11.3-GCCcore-12.3.0/lib -o /tmp/vsc45304/easybuild/build/CIRCE/0.2.2/foss-2023a/circe_py/circe_py-0.2.2/build/lib.linux-x86_64-cpython-311/circe/pyquic.cpython-311-x86_64-linux-gnu.so -lflexiblas
